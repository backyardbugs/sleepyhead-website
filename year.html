<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain's Log 2025 - Sleepyhead</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css?v=4">

    <style>
        /* --- ALMANAC SPECIFIC STYLES --- */
        
        /* 1. THE HUD (Stats at the top) */
        .hud-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            border-bottom: 1px solid #333;
            padding-bottom: 40px;
        }

        .hud-box {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            text-align: center;
        }

        .hud-label {
            font-family: var(--font-head);
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 5px;
        }

        .hud-value {
            font-family: var(--font-head);
            font-size: 1.8rem;
            color: var(--accent-color);
            font-weight: bold;
        }

        /* 2. THE HEATMAP (The Year Grid) */
        .calendar-wrapper {
            overflow-x: auto; /* Scroll sideways on mobile */
            padding-bottom: 20px;
            margin-bottom: 60px;
            /* Hide scrollbar for cleaner look */
            scrollbar-width: thin;
            scrollbar-color: #333 #111;
        }

        .calendar-grid {
            display: grid;
            /* 53 Columns (Weeks) */
            grid-template-columns: repeat(53, 1fr); 
            /* 7 Rows (Days) */
            grid-template-rows: repeat(7, 1fr);     
            grid-auto-flow: column; /* Fill top-to-bottom, then move right */
            gap: 4px;
            min-width: 800px; /* Force it to be wide so squares stay square */
        }

        .day-cell {
            width: 12px;
            height: 12px;
            background-color: #222; /* Default: Empty */
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        /* 3. THE GLOBAL TOOLTIP (The Floating Info Box) */
        #tooltip {
            position: fixed; /* Floats above everything */
            background: #000;
            color: #fff;
            padding: 8px 12px;
            border: 1px solid #444;
            font-size: 0.75rem;
            font-family: var(--font-head);
            white-space: pre;
            z-index: 1000; /* Super high priority */
            pointer-events: none; /* Let mouse click through it */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.1s;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transform: translate(-50%, -120%); /* Center above cursor */
        }

        /* COLOR LEVELS (Word Count) */
        .lvl-0 { background-color: #222; }
        .lvl-1 { background-color: #333; }             /* < 500 words */
        .lvl-2 { background-color: #8a703e; }          /* 500 - 1500 */
        .lvl-3 { background-color: var(--accent-color); } /* 1500+ */

        /* GYM INDICATOR (The Dot) */
        .gym-dot {
            width: 4px;
            height: 4px;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 2px #000; /* Shadow to make it pop on bright gold */
        }

        /* 4. THE LEDGERS (Lists) */
        .ledger-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
        }

        @media (max-width: 768px) {
            .ledger-grid { grid-template-columns: 1fr; gap: 40px; }
        }

        .ledger-item {
            border-bottom: 1px dashed #333;
            padding: 10px 0;
            font-size: 0.95rem;
        }
        
        .ledger-title { color: #fff; font-weight: bold; }
        .ledger-meta { color: #888; font-size: 0.85rem; display: block; margin-top: 4px;}
        .rating-stars { color: var(--accent-color); font-size: 0.8rem; margin-left: 10px; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            padding: 15px 0;
            font-family: var(--font-head);
        }
    </style>
</head>
<body>

    <div class="container">
        
        <aside id="sidebar-container"></aside>

        <main>
            <h1 id="year-title" style="font-family: var(--font-head); border-bottom: 2px solid #fff; padding-bottom: 10px;">
                Captain's Log <span style="color:var(--accent-color)">//</span> 2026
            </h1>

            <div style="margin-bottom: 20px; font-family: var(--font-head); font-size: 0.9rem; margin-top: 10px;">
                <span style="color:#666; margin-right:10px;">SELECT YEAR:</span>
                <a href="?y=2025" style="margin-right: 10px;">[ 2025 ]</a>
                <a href="?y=2026">[ 2026 ]</a>
            </div>

            <div class="hud-container">
                <div class="hud-box">
                    <span class="hud-label">Total Words</span>
                    <span class="hud-value" id="total-words">0</span>
                </div>
                <div class="hud-box">
                    <span class="hud-label">Workouts</span>
                    <span class="hud-value" id="total-workouts">0</span>
                </div>
                <div class="hud-box">
                    <span class="hud-label">Books Read</span>
                    <span class="hud-value" id="total-books">0</span>
                </div>
            </div>

            <h2 class="post-title" style="font-size: 1.2rem; color: #666;">Consistency Graph</h2>
            <div class="calendar-wrapper">
                <div id="year-grid" class="calendar-grid">
                    </div>
            </div>
            
            <div style="display:flex; gap:20px; font-size:0.75rem; color:#666; font-family:var(--font-head); margin-bottom:60px;">
                <span>Color = Word Count intensity</span>
                <span>• Dot = Gym Session</span>
            </div>

            <div class="ledger-grid">
                
                <div>
                    <h2 class="post-title">Library</h2>
                    <div id="book-list"></div>
                </div>

                <div>
                    <h2 class="post-title">Bands Seen</h2>
                    <div id="band-list"></div>
                </div>

            </div>

        </main>
    </div>

    <div id="tooltip"></div>

    <script src="data/2025.js"></script>
    <script src="data/2026.js"></script>
    
    <script src="loader.js?v=4"></script>

    <script>
        /* --- THE ENGINE --- */
        document.addEventListener("DOMContentLoaded", function() {
            
            // 0. YEAR SELECTION
            const params = new URLSearchParams(window.location.search);
            const currentYear = parseInt(params.get('y')) || 2026;

            // Update Titles
            document.title = `Captain's Log ${currentYear} - Sleepyhead`;
            document.getElementById('year-title').innerHTML = `Captain's Log <span style="color:var(--accent-color)">//</span> ${currentYear}`;

            // Select Data Sources
            let activeHistory = [];
            let activeBooks = [];
            let activeAlbums = [];
            let activeStats = [];
            let activeShows = [];

            if (currentYear === 2025) {
                activeHistory = (typeof history2025 !== 'undefined') ? history2025 : [];
                activeBooks = (typeof books2025 !== 'undefined') ? books2025 : [];
                activeAlbums = (typeof albums2025 !== 'undefined') ? albums2025 : [];
                activeStats = (typeof stats2025 !== 'undefined') ? stats2025 : [];
                activeShows = (typeof shows2025 !== 'undefined') ? shows2025 : [];
            } else {
                activeHistory = (typeof history2026 !== 'undefined') ? history2026 : [];
                activeBooks = (typeof books2026 !== 'undefined') ? books2026 : [];
                activeAlbums = (typeof albums2026 !== 'undefined') ? albums2026 : [];
                activeStats = (typeof stats2026 !== 'undefined') ? stats2026 : [];
                activeShows = (typeof shows2026 !== 'undefined') ? shows2026 : [];
            }

            // 1. PROCESS TOTALS
            let totalWords = 0;
            let totalWorkouts = 0;

            // Create a quick lookup map for dates: "2025-01-01" -> { words: 500, gym: true }
            const dayMap = {};

            activeHistory.forEach(entry => {
                const date = entry[0];
                const words = entry[1];
                const gym = entry[2];
                const note = entry[3] || "";

                totalWords += words;
                if (gym) totalWorkouts++;

                dayMap[date] = { words, gym, note };
            });

            // Update HUD
            document.getElementById('total-words').innerText = totalWords.toLocaleString();
            document.getElementById('total-workouts').innerText = totalWorkouts;
            
            const totalBooksEl = document.getElementById('total-books');
            const totalAlbumsEl = document.getElementById('total-albums');
            
            if (totalBooksEl && activeBooks) totalBooksEl.innerText = activeBooks.length;
            if (totalAlbumsEl && activeAlbums) totalAlbumsEl.innerText = activeAlbums.length; 

            // --- ADVANCED STATS CALCULATION ---
            let maxWords = 0;
            let currentWritingStreak = 0;
            let longestWritingStreak = 0;
            let currentWorkoutStreak = 0;
            let longestWorkoutStreak = 0;

            let lastWritingDate = null;
            let lastWorkoutDate = null;

            // Sort history by date to ensure proper streak calculation
            const sortedHistory = activeHistory.slice().sort((a, b) => new Date(a[0]) - new Date(b[0]));
            
            // Helpful Set for O(1) lookups of dates that exist in history with >0 words or gym
            const writingDays = new Set();
            const workoutDays = new Set();

            sortedHistory.forEach(entry => {
                const d = entry[0];
                const w = entry[1];
                const g = entry[2];

                if (w > maxWords) maxWords = w;
                if (w > 0) {
                    writingDays.add(d);
                    lastWritingDate = d;
                }
                if (g) {
                    workoutDays.add(d);
                    lastWorkoutDate = d;
                }
            });

            // Calculate Streaks (Iterate through the year up to "today" or last entry?)
            // A streak requires consecutive days.
            // Let's iterate through the sorted history dates is not enough because skipped days break streaks.
            // We should iterate from Jan 1st to Today.
            
            const today = new Date(); // Actual today
            const jan1 = new Date(currentYear, 0, 1);
            
            let wStreak = 0;
            let gStreak = 0;
            
            // We iterate day by day from Jan 1 to Today (or end of year if viewing past year)
            let loopEnd = (currentYear < today.getFullYear()) ? new Date(currentYear, 11, 31) : today;
            
            for (let d = new Date(jan1); d <= loopEnd; d.setDate(d.getDate() + 1)) {
                // ISO YYYY-MM-DD
                const offset = d.getTimezoneOffset(); 
                const localDate = new Date(d.getTime() - (offset*60*1000));
                const iso = localDate.toISOString().split('T')[0];

                // Writing Streak
                if (writingDays.has(iso)) {
                    wStreak++;
                    if (wStreak > longestWritingStreak) longestWritingStreak = wStreak;
                } else {
                    wStreak = 0;
                }

                // Workout Streak
                if (workoutDays.has(iso)) {
                    gStreak++;
                    if (gStreak > longestWorkoutStreak) longestWorkoutStreak = gStreak;
                } else {
                    gStreak = 0;
                }
            }

            // Days Since (Only relevant if viewing CURRENT YEAR)
            // Helper to differ days
            const diffDays = (d1, d2) => Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
            
            const isPastYear = currentYear < today.getFullYear();
            const daysSinceWrite = (lastWritingDate && !isPastYear) ? diffDays(today, new Date(lastWritingDate)) : "-";
            const daysSinceGym = (lastWorkoutDate && !isPastYear) ? diffDays(today, new Date(lastWorkoutDate)) : "-";

            // Inject into DOM 
            
            let advancedStatsHTML = `
                <div class="hud-box" style="grid-column: span 2;">
                   <div style="display:flex; justify-content:space-around; text-align:center;">
                        <div>
                            <span class="hud-label">Longest Write Streak</span>
                            <span class="hud-value">${longestWritingStreak}</span>
                        </div>
                        <div>
                            <span class="hud-label">Max Words/Day</span>
                            <span class="hud-value">${maxWords}</span>
                        </div>
                        <div>
                            <span class="hud-label">Longest Gym Streak</span>
                            <span class="hud-value">${longestWorkoutStreak}</span>
                        </div>
                   </div>`;

            // Only show "Days Since" row if it is the current year
            if (!isPastYear) {
                advancedStatsHTML += `
                   <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #333; display:flex; justify-content:space-around;">
                        <div>
                            <span class="hud-label">Days Since Writing</span>
                            <span class="hud-value" style="color:${daysSinceWrite > 7 ? 'red' : '#888'}">${daysSinceWrite}</span>
                        </div>
                        <div>
                            <span class="hud-label">Days Since Gym</span>
                            <span class="hud-value" style="color:${daysSinceGym > 7 ? 'red' : '#888'}">${daysSinceGym}</span>
                        </div>
                   </div>
                `;
            }

            // Add the Toggle Link at the bottom of the HUD grid
            if (currentYear === 2026 && typeof history2025 !== 'undefined') {
                 advancedStatsHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; margin-top: 10px; border-top: 1px dashed #333; padding-top: 10px;">
                        <a href="#" id="toggle-pace" style="color: #444; font-family: var(--font-head); font-size: 0.8rem; text-decoration: none; transition: color 0.2s;">[ Show Last Year Pace ]</a>
                    </div>
                 `;
            }

            advancedStatsHTML += `</div>`;
            
            // Append to HUD
            const hud = document.querySelector('.hud-container');
            if(hud) {
                // Check if we already added it to avoid dupes on re-renders (if specific logic existed)
                // Just appending is fine for now as this runs once on load
                hud.insertAdjacentHTML('beforeend', advancedStatsHTML);
                
                // --- GHOST SHIP LOGIC (Option 1: Ghost Text) ---
                const toggleBtn = document.getElementById('toggle-pace');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Check if already active
                        const isActive = toggleBtn.classList.contains('active');
                        
                        if (!isActive) {
                            // TURN ON
                            toggleBtn.classList.add('active');
                            toggleBtn.innerHTML = "[ Hide Last Year Pace ]";
                            toggleBtn.style.color = "var(--accent-color)";
                            
                            // 1. Calculate 2025 YTD
                            const now = new Date();
                            const currentMonth = now.getMonth();
                            const currentDay = now.getDate();
                            
                            let words2025 = 0;
                            let workouts2025 = 0;
                            
                            history2025.forEach(entry => {
                                const d = new Date(entry[0] + "T00:00:00");
                                if (d.getFullYear() === 2025) {
                                    if (d.getMonth() < currentMonth || (d.getMonth() === currentMonth && d.getDate() <= currentDay)) {
                                        words2025 += entry[1];
                                        if (entry[2]) workouts2025++;
                                    }
                                }
                            });

                            // 2. Calculate Diffs
                            const wordDiff = totalWords - words2025;
                            const gymDiff = totalWorkouts - workouts2025;
                            
                            // 3. Inject Ghost Text
                            injectGhostStat('total-words', words2025, wordDiff);
                            injectGhostStat('total-workouts', workouts2025, gymDiff);

                        } else {
                            // TURN OFF
                            toggleBtn.classList.remove('active');
                            toggleBtn.innerHTML = "[ Show Last Year Pace ]";
                            toggleBtn.style.color = "#444";
                            
                            // Remove elements
                            document.querySelectorAll('.ghost-stat').forEach(el => el.remove());
                        }
                    });
                }
            }

            function injectGhostStat(elementId, pastValue, diff) {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                const parent = el.parentNode;
                // Remove existing if any (safety)
                const existing = parent.querySelector('.ghost-stat');
                if (existing) existing.remove();

                const sign = diff >= 0 ? "+" : "";
                const color = diff >= 0 ? "var(--accent-color)" : "#ff4444";
                
                const html = `
                    <div class="ghost-stat" style="font-family: var(--font-head); font-size: 0.8rem; color: #666; margin-top: 5px; animation: fadeIn 0.5s;">
                        <span style="color:${color}">${sign}${diff.toLocaleString()}</span> vs 2025
                    </div>
                `;
                
                parent.insertAdjacentHTML('beforeend', html);
            }

            // 2. GENERATE CALENDAR GRID (Jan 1 to Dec 31)
            const gridContainer = document.getElementById('year-grid');
            if (gridContainer) {
                gridContainer.innerHTML = ""; // Clear for re-render if needed
                const startDate = new Date(currentYear, 0, 1); // Jan 1
                const endDate = new Date(currentYear, 11, 31); // Dec 31
                
                // Iterate through every single day of the year
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    
                    // Format date as YYYY-MM-DD (Local)
                    const offset = d.getTimezoneOffset(); 
                    const localDate = new Date(d.getTime() - (offset*60*1000));
                    const isoDate = localDate.toISOString().split('T')[0];
                    
                    // Get data for this day (or default to 0)
                    const data = dayMap[isoDate] || { words: 0, gym: false, note: "" };

                    // Create the HTML square
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';

                    // Current Day Indicator
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (isoDate === todayStr) {
                        cell.style.border = "2px solid #fff";
                        cell.style.zIndex = "10";
                    }
                    
                    // Determine Color Level
                    if (data.words > 1500) cell.classList.add('lvl-3');
                    else if (data.words > 500) cell.classList.add('lvl-2');
                    else if (data.words > 0) cell.classList.add('lvl-1');
                    else cell.classList.add('lvl-0');

                    // Add Gym Dot
                    if (data.gym) {
                        const dot = document.createElement('div');
                        dot.className = 'gym-dot';
                        cell.appendChild(dot);
                    }

                    // Prepare Tooltip Data
                    const dateString = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    let tooltipText = `${dateString}\nWords: ${data.words}`;
                    if (data.gym) tooltipText += `\nGym: Yes`;
                    if (data.note) tooltipText += `\n"${data.note}"`;
                    
                    cell.setAttribute('data-tooltip', tooltipText);

                    gridContainer.appendChild(cell);
                }
            }

            /* --- TOOLTIP LOGIC (The Floating Fix) --- */
            const tooltip = document.getElementById('tooltip');
            const cells = document.querySelectorAll('.day-cell');

            cells.forEach(cell => {
                cell.addEventListener('mouseenter', (e) => {
                    const text = e.target.getAttribute('data-tooltip');
                    if (text) {
                        tooltip.innerText = text;
                        tooltip.style.opacity = '1';
                    }
                });

                cell.addEventListener('mousemove', (e) => {
                    // Move the tooltip with the mouse, offset slightly up
                    tooltip.style.left = e.clientX + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                cell.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                });
            });


            // 3. RENDER LISTS
            
            // Books
            const bookContainer = document.getElementById('book-list');
            if (bookContainer && activeBooks) {
                bookContainer.innerHTML = "";
                activeBooks.forEach(book => {
                    let metaHTML = `by ${book.author}`;
                    if (book.review) {
                        metaHTML += ` — <em>"${book.review}"</em>`;
                    }
                    
                    bookContainer.innerHTML += `
                        <div class="ledger-item">
                            <span class="ledger-title">${book.title}</span>
                            <span class="ledger-meta">${metaHTML}</span>
                        </div>
                    `;
                });
            }

            // Albums
            const albumContainer = document.getElementById('album-list');
            if (albumContainer && activeAlbums) {
                albumContainer.innerHTML = "";
                activeAlbums.forEach(album => {
                    albumContainer.innerHTML += `
                        <div class="ledger-item">
                            <span class="ledger-title">${album.title}</span>
                            <span class="rating-stars">${"★".repeat(album.rating)}</span>
                            <span class="ledger-meta">${album.artist}</span>
                        </div>
                    `;
                });
            }

            // PR Stats
            const statsContainer = document.getElementById('stats-list');
            if (statsContainer && activeStats) {
                statsContainer.innerHTML = "";
                activeStats.forEach(stat => {
                    statsContainer.innerHTML += `
                        <div class="stat-row">
                            <span>${stat.label}</span>
                            <span style="color:#fff; font-weight:bold;">${stat.value}</span>
                        </div>
                    `;
                });
            }

            // Bands Seen
            const bandContainer = document.getElementById('band-list');
            if (bandContainer && activeShows) {
                let html = '<ul style="list-style:none; padding:0; color:#888; font-family: var(--font-head);">';
                activeShows.forEach(band => {
                    html += `
                        <li style="border-bottom:1px dashed #333; padding:10px 0;">
                            <span style="color:#fff">${band}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                bandContainer.innerHTML = html;
            }

        });
    </script>
</body>
</html>